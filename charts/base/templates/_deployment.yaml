{{- define "base.deployment" -}}
{{- $volumeDict := dict -}}
{{- range $index, $volume := .Values.volumes -}}
{{- $_ := set $volumeDict $volume.name $volume -}}
{{- end -}}
apiVersion: apps/v1
kind: Deployment
{{ include "base.metadata" . }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: {{ include "base.name" . }}
  template:
    {{- include "base.metadata" . | nindent 4 }}
    spec:
      containers:
      {{- range $index, $container := .Values.containers }}
      - image: {{ $container.image }}
        name: {{ $container.name }}
        {{- if $container.staticEnvs }}
        env:
        {{- range $index, $staticEnv := $container.staticEnvs }}
        - name: {{ $staticEnv.name }}
          value: {{ $staticEnv.value }}
        {{- end }}
        {{- end -}}
        {{- if $container.ports }}
        ports:
        {{- range $index, $port := $container.ports }}
        - containerPort: {{ $port }}
        {{- end }}
        {{- end -}}
        {{- if $container.volumeMounts }}
        volumeMounts:
        {{- range $volumeName := $container.volumeMounts }}
        {{ $volume := get $volumeDict $volumeName -}}
        - name: {{ $volume.name }}
          mountPath: {{ $volume.mountPath }}
        {{- end }}
        {{- end -}}
      {{- end }}
      imagePullSecrets:
      - name: registry.paul-steele.com
      {{- if .Values.volumes }}
      volumes:
      {{- range $index, $volume := .Values.volumes }}
      - name: {{ $volume.name }}
        nfs:
          path: {{ $volume.source.nfs }}
          server: 192.168.0.105
      {{- end }}
      {{- end -}}
{{- end -}}
